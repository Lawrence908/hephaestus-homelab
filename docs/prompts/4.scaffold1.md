Below are drop-in files to:

1. stand up **Grafana + Prometheus + cAdvisor + Node Exporter**, and
    
2. scaffold containers/folders for your five apps (Django, Flask×2, FastAPI, static frontend).
    

They plug straight into your existing `web` network and Caddy.

---

# 1) Grafana stack

## `~/homelab/grafana-stack/docker-compose.yml`

```yaml
name: grafana-stack

networks:
  web:
    external: true

volumes:
  grafana_data:
  prometheus_data:

services:
  prometheus:
    image: prom/prometheus:v2.55.0
    container_name: prometheus
    restart: unless-stopped
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.retention.time=15d
      - --storage.tsdb.path=/prometheus
      - --web.enable-lifecycle
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"            # optionally route via Caddy later
    networks: [web]
    labels: ["com.centurylinklabs.watchtower.enable=true"]

  grafana:
    image: grafana/grafana:10.4.3
    container_name: grafana
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=change_me
    volumes:
      - grafana_data:/var/lib/grafana
    ports:
      - "3000:3000"            # optionally route via Caddy later
    networks: [web]
    labels: ["com.centurylinklabs.watchtower.enable=true"]

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.49.1
    container_name: cadvisor
    restart: unless-stopped
    privileged: true
    command: ["--docker_only=true"]
    volumes:
      - /:/rootfs:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /sys:/sys:ro
      - /dev/disk/:/dev/disk:ro
    networks: [web]
    labels: ["com.centurylinklabs.watchtower.enable=true"]

  node-exporter:
    image: prom/node-exporter:v1.8.1
    container_name: node-exporter
    restart: unless-stopped
    pid: host
    network_mode: host
    command:
      - --path.rootfs=/
    labels: ["com.centurylinklabs.watchtower.enable=true"]
```

## `~/homelab/grafana-stack/prometheus.yml`

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 30s

scrape_configs:
  - job_name: prometheus
    static_configs:
      - targets: ["prometheus:9090"]

  - job_name: cadvisor
    static_configs:
      - targets: ["cadvisor:8080"]

  - job_name: node-exporter
    static_configs:
      - targets: ["127.0.0.1:9100"]   # node-exporter is host network

  # Uptime Kuma metrics (enable in Kuma: Settings → Enable Prometheus Metrics)
  - job_name: uptime-kuma
    scrape_interval: 30s
    static_configs:
      - targets: ["uptime-kuma:3001"]
```

**Bring up:**

```bash
cd ~/homelab
docker network create web 2>/dev/null || true
mkdir -p grafana-stack
cd grafana-stack
# paste the two files above
docker compose up -d
```

Visit:

- Prometheus: `http://<LAN-IP>:9090`
    
- Grafana: `http://<LAN-IP>:3000` (admin / change_me)
    

(If you want them **only** behind Caddy/Cloudflare Tunnel, remove the `ports:` and add Caddy routes pointing at `grafana:3000` and `prometheus:9090`.)

---

# 2) App scaffolds

Each app gets a folder, a `Dockerfile`, and a service block (you’ll wire routes in `Caddyfile`). All services join network `web`. No host ports are published; Caddy reverse-proxies internally.

## A) MagicPages API — **Django + Gunicorn** (Supabase DB)

**Folders**

```
~/homelab/magic-pages/
  Dockerfile
  requirements.txt
  entrypoint.sh
  app/                # your Django project (manage.py lives here)
  .env.magicpages     # DJANGO secrets + DATABASE_URL to Supabase
```

**`~/homelab/magic-pages/Dockerfile`**

```dockerfile
FROM python:3.11-slim
WORKDIR /app
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1
RUN apt-get update && apt-get install -y --no-install-recommends gcc libpq-dev && rm -rf /var/lib/apt/lists/*
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh
COPY app /app
ENTRYPOINT ["/entrypoint.sh"]
```

**`~/homelab/magic-pages/requirements.txt`** (example)

```
Django>=4.2
gunicorn
psycopg[binary]
dj-database-url
whitenoise
```

**`~/homelab/magic-pages/entrypoint.sh`**

```bash
#!/usr/bin/env bash
set -e
# Export env from .env.magicpages if present
if [ -f "/app/.env.magicpages" ]; then
  export $(grep -v '^#' /app/.env.magicpages | xargs)
fi
# Migrations + static
python manage.py migrate --noinput
python manage.py collectstatic --noinput || true
# Run
exec gunicorn ${DJANGO_WSGI_MODULE:-app.wsgi}:application -b 0.0.0.0:8000 --workers 3 --timeout 90
```

**`~/homelab/magic-pages/.env.magicpages` (example)**

```
DJANGO_SECRET_KEY=replace_me
DJANGO_DEBUG=False
ALLOWED_HOSTS=*
DATABASE_URL=postgresql://<user>:<pass>@<supabase-host>:5432/<db>?sslmode=require
DJANGO_WSGI_MODULE=app.wsgi
```

**Compose service (add to your main `~/homelab/docker-compose.yml`):**

```yaml
  magic-pages:
    build: ./magic-pages
    container_name: magic-pages
    restart: unless-stopped
    environment:
      - PYTHONUNBUFFERED=1
    volumes:
      - ./magic-pages/app:/app
      - ./magic-pages/.env.magicpages:/app/.env.magicpages:ro
    networks: [web]
    labels: ["com.centurylinklabs.watchtower.enable=true"]
```

**Caddy route**

```caddy
api.magicpages.chrislawrence.ca {
  reverse_proxy magic-pages:8000
}
```

---

## B) Portfolio website — **Flask + Gunicorn**

**Folders**

```
~/homelab/portfolio/
  Dockerfile
  requirements.txt
  app/
    app.py   # Flask app object = app
```

**`~/homelab/portfolio/Dockerfile`**

```dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY app /app
CMD ["gunicorn", "app:app", "-b", "0.0.0.0:8000", "--workers", "2"]
```

**`~/homelab/portfolio/requirements.txt`**

```
Flask>=2.3
gunicorn
```

**Compose service**

```yaml
  portfolio:
    build: ./portfolio
    container_name: portfolio
    restart: unless-stopped
    networks: [web]
    labels: ["com.centurylinklabs.watchtower.enable=true"]
```

**Caddy route**

```caddy
portfolio.chrislawrence.ca {
  reverse_proxy portfolio:8000
}
# or keep using nasty.chrislawrence.ca as your catch-all to portfolio
```

---

## C) SchedShare — **Flask + Gunicorn**

**Folders**

```
~/homelab/schedshare/
  Dockerfile
  requirements.txt
  app/
    app.py
  .env.schedshare   # if needed
```

**`~/homelab/schedshare/Dockerfile`**

```dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY app /app
CMD ["gunicorn", "app:app", "-b", "0.0.0.0:8080", "--workers", "2"]
```

**`~/homelab/schedshare/requirements.txt`**

```
Flask>=2.3
gunicorn
```

**Compose service**

```yaml
  schedshare:
    build: ./schedshare
    container_name: schedshare
    restart: unless-stopped
    env_file:
      - ./schedshare/.env.schedshare
    networks: [web]
    labels: ["com.centurylinklabs.watchtower.enable=true"]
```

**Caddy route**

```caddy
schedshare.chrislawrence.ca {
  reverse_proxy schedshare:8080
}
```

---

## D) CapitolScope — **FastAPI + Gunicorn/Uvicorn**

**Folders**

```
~/homelab/capitolscope/
  Dockerfile
  requirements.txt
  app/
    main.py    # FastAPI app object = app
  .env.capitol # DATABASE_URL etc.
```

**`~/homelab/capitolscope/Dockerfile`**

```dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY app /app
ENV PYTHONUNBUFFERED=1
CMD ["gunicorn", "main:app", "-k", "uvicorn.workers.UvicornWorker", "-b", "0.0.0.0:8000", "--workers", "2"]
```

**`~/homelab/capitolscope/requirements.txt`**

```
fastapi
uvicorn[standard]
gunicorn
psycopg[binary]
SQLAlchemy
```

**Compose service**

```yaml
  capitolscope:
    build: ./capitolscope
    container_name: capitolscope
    restart: unless-stopped
    env_file:
      - ./capitolscope/.env.capitol
    networks: [web]
    labels: ["com.centurylinklabs.watchtower.enable=true"]
```

**`~/homelab/capitolscope/.env.capitol` (example)**

```
DATABASE_URL=postgresql://user:pass@host:5432/dbname?sslmode=require
```

**Caddy route**

```caddy
capitolscope.chrislawrence.ca {
  reverse_proxy capitolscope:8000
}
```

---

## E) Magic Pages Frontend — **Static** (Nginx)

If you’re cloning the WP site’s _front-end only_ (static export), serve it via nginx.

**Folders**

```
~/homelab/magicpages-frontend/
  docker-compose.yml  (optional if you want it separate)
  nginx.conf          (optional)
  site/               # built static files (index.html, assets, etc.)
```

**Compose service (add to main compose instead if you prefer)**

```yaml
  magicpages-frontend:
    image: nginx:alpine
    container_name: magicpages-frontend
    restart: unless-stopped
    volumes:
      - ./magicpages-frontend/site:/usr/share/nginx/html:ro
      # - ./magicpages-frontend/nginx.conf:/etc/nginx/conf.d/default.conf:ro  # if you need custom headers
    networks: [web]
    labels: ["com.centurylinklabs.watchtower.enable=true"]
```

**Caddy route**

```caddy
magicpages.com {
  reverse_proxy magicpages-frontend:80
}
```

_(If you decide to rebuild as React/Next, I’ll swap in a multi-stage Node build → nginx.)_

---

## Create folders quickly

```bash
cd ~/homelab
mkdir -p grafana-stack \
         magic-pages/app \
         portfolio/app \
         schedshare/app \
         capitolscope/app \
         magicpages-frontend/site
```

Then paste the files above into their paths, add the service blocks to your **existing** `~/homelab/docker-compose.yml` (Hephaestus mono-stack), and:

```bash
docker compose build --no-cache magic-pages portfolio schedshare capitolscope
docker compose up -d
docker compose ps
```

---

## Caddy updates

Open `~/homelab/proxy/Caddyfile` and ensure the routes you want are present (examples above). Reload:

```bash
docker compose -f ~/homelab/docker-compose.yml restart caddy
```

---

## Security notes

- Protect Grafana/Prometheus behind **Caddy** and/or **Cloudflare Tunnel** (no WAN ports), or keep them LAN-only.
    
- Keep app secrets in `.env.*` files (not committed).
    
- Supabase `DATABASE_URL` must use `sslmode=require`.
