Here are ready-to-drop-in **YAML** files for **Hephaestus (OptiPlex 7040, Ubuntu Server)**. They mirror the plan we discussed: reverse proxy + tunnel, Uptime Kuma, Portainer, Watchtower, Glances, and app slots for your sites.

---

### `~/homelab/docker-compose.yml` _(mono-stack, easiest to run)_

```yaml
name: hephaestus

# Shared external network so services can discover each other by name
networks:
  web:
    external: true

volumes:
  caddy_data:
  caddy_config:
  portainer_data:

services:
  # ---------- Ingress ----------
  caddy:
    image: caddy:2
    container_name: caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./proxy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    networks: [web]
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # No router port-forwards needed when using a Cloudflare Tunnel
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    networks: [web]
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # ---------- Monitoring & Management ----------
  uptime-kuma:
    image: louislam/uptime-kuma:1
    container_name: uptime-kuma
    restart: unless-stopped
    volumes:
      - ./uptime-kuma/data:/app/data
    # If you want LAN access directly (bypass proxy), uncomment:
    # ports:
    #   - "3001:3001"
    networks: [web]
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: unless-stopped
    ports:
      - "9443:9443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  glances:
    image: nicolargo/glances:latest
    container_name: glances
    restart: unless-stopped
    environment:
      - GLANCES_OPT=--webserver
    ports:
      - "61208:61208"   # http://<LAN-IP>:61208
    pid: host
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    command: --label-enable --cleanup --interval 1800
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  # ---------- Your Sites (samples/placeholders) ----------
  # Static portfolio (nginx)
  portfolio:
    image: nginx:alpine
    container_name: portfolio
    restart: unless-stopped
    volumes:
      - ./portfolio/html:/usr/share/nginx/html:ro
    networks: [web]
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # Magic Pages API (Python, adjust as needed)
  magic-pages:
    image: python:3.11-slim
    container_name: magic-pages
    working_dir: /app
    command: bash -lc "pip install -r requirements.txt && gunicorn app:app -b 0.0.0.0:8000 --workers 2"
    restart: unless-stopped
    volumes:
      - ./magic-pages:/app
    environment:
      - PYTHONUNBUFFERED=1
    networks: [web]
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # CapitolScope: Flask + Postgres
  capitolscope-db:
    image: postgres:16-alpine
    container_name: capitolscope-db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=capitol
      - POSTGRES_PASSWORD=${CAPITOL_DB_PASSWORD:-change_me}
      - POSTGRES_DB=capitolscope
    volumes:
      - ./capitolscope/db:/var/lib/postgresql/data
    networks: [web]
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  capitolscope:
    image: python:3.11-slim
    container_name: capitolscope
    depends_on:
      - capitolscope-db
    working_dir: /app
    command: bash -lc "pip install -r requirements.txt && gunicorn app:app -b 0.0.0.0:8000 --workers 2"
    restart: unless-stopped
    volumes:
      - ./capitolscope/app:/app
    environment:
      - DATABASE_URL=postgresql://capitol:${CAPITOL_DB_PASSWORD:-change_me}@capitolscope-db:5432/capitolscope
      - PYTHONUNBUFFERED=1
    networks: [web]
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # SchedShare (adjust port/command to your app)
  schedshare:
    image: python:3.11-slim
    container_name: schedshare
    working_dir: /app
    command: bash -lc "pip install -r requirements.txt && gunicorn app:app -b 0.0.0.0:8080 --workers 2"
    restart: unless-stopped
    volumes:
      - ./schedshare:/app
    networks: [web]
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
```

---

### `~/homelab/proxy/Caddyfile` _(routes; simple to start)_

```caddy
# LAN-only test names (add these to your hosts file or local DNS if you want)
kuma.local.lan {
  reverse_proxy uptime-kuma:3001
}

portfolio.local.lan {
  reverse_proxy portfolio:80
}

# Public hostnames via Cloudflare Tunnel (no router port-forwards needed)
# Point each to the right internal service by name:port
nasty.chrislawrence.ca {
  reverse_proxy portfolio:80
}

api.magicpages.chrislawrence.ca {
  reverse_proxy magic-pages:8000
}

capitolscope.chrislawrence.ca {
  reverse_proxy capitolscope:8000
}

schedshare.chrislawrence.ca {
  reverse_proxy schedshare:8080
}
```

---

### `~/homelab/.env` _(secrets + easy tweaks; don’t commit)_

```env
# Cloudflare > Zero Trust > Tunnels > <your tunnel> > Tunnel Token
CLOUDFLARE_TUNNEL_TOKEN=PASTE_TUNNEL_TOKEN_HERE

# Database secret for CapitolScope
CAPITOL_DB_PASSWORD=super_strong_password_here
```

---

### First-run quickstart

```bash
# one-time shared network
docker network create web

# bring up the whole stack
cd ~/homelab
docker compose up -d

# verify
docker compose ps
```

Open:

- Kuma: `http://<Hephaestus LAN IP>:3001` (or via `kuma.local.lan` if you added hosts/DNS)
    
- Portainer: `https://<LAN IP>:9443`
    
- Glances: `http://<LAN IP>:61208`
    

In Cloudflare → Tunnel → **Public Hostnames**, map:

- `nasty.chrislawrence.ca` → HTTP → `http://caddy:80`
    

_(Cloudflared can resolve `caddy` because it’s on the same `web` network.)_

---

### Optional: split stacks (each with its own compose)

If you prefer separate folders, you can copy the relevant service blocks to:

- `proxy/docker-compose.yml` (caddy + cloudflared)
    
- `uptime-kuma/docker-compose.yml`
    
- `portainer/docker-compose.yml`
    
- `watchtower/docker-compose.yml`
    
- etc.
    

Each still uses the external `web` network:

```yaml
networks:
  web:
    external: true
```
