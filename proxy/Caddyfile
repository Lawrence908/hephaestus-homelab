# Hephaestus Homelab - Secure Caddy Configuration
# Subdomain-based routing with Cloudflare Access protection

# Global configuration
{
    admin 127.0.0.1:2019
    auto_https off
    http_port 80
}

localhost:80 {
    respond "Hello from Caddy!" 200
}

chrislawrence.ca:80 {
    root * /var/www/landing
    file_server
}

# www subdomain redirect to main domain
www.chrislawrence.ca:80 {
    redir https://chrislawrence.ca{uri} 301
}

# ============================================================================
# PUBLIC SUBDOMAINS (No Authentication Required) - TEMPORARILY COMMENTED OUT
# ============================================================================

# Portfolio subdomain
portfolio.chrislawrence.ca:80 {
    reverse_proxy portfolio:5000 {
        header_up X-Forwarded-Prefix /portfolio
        header_up Host {host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-For {remote}
        header_up X-Real-IP {remote}
    }
    
    log {
        level INFO
        format json
        output file /data/logs/portfolio.json {
            roll_size 15mb
            roll_keep 8
            roll_keep_for 168h
        }
    }
}

# SchedShare subdomain
schedshare.chrislawrence.ca:80 {
    reverse_proxy schedshare:5000 {
        header_up X-Forwarded-Prefix /schedshare
        header_up Host {host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-For {remote}
        header_up X-Real-IP {remote}
    }
    
    log {
        level INFO
        format json
        output file /data/logs/schedshare.json {
            roll_size 15mb
            roll_keep 8
            roll_keep_for 168h
        }
    }
}

# CapitolScope subdomain
capitolscope.chrislawrence.ca:80 {
    # API matcher
    @api path_regexp ^/api/.*
    
    # Handle API routes first (more specific)
    handle @api {
        reverse_proxy capitolscope:8000 {
            header_up Host {host}
            header_up X-Forwarded-Proto https
            header_up X-Forwarded-For {remote}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-Host {host}
        }
        header {
            Access-Control-Allow-Origin "*"
            Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
            Access-Control-Allow-Headers "Content-Type, Authorization"
        }
    }
    
    # Frontend - serve everything else to Vite dev server
    # Vite automatically serves files from the public/ directory
    handle {
        reverse_proxy capitolscope-frontend:5173 {
            header_up Host {host}
            header_up X-Forwarded-Proto https
            header_up X-Forwarded-For {remote}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-Host {host}
        }
    }
    
    log {
        level INFO
        format json
        output file /data/logs/capitolscope.json {
            roll_size 15mb
            roll_keep 8
            roll_keep_for 168h
        }
    }
}

# MagicPages subdomain
magicpages.chrislawrence.ca:80 {
    reverse_proxy magicpages-api:8000 {
        header_up Host {host}
        header_up X-Forwarded-Host {host}
        header_up X-Forwarded-Proto https
        header_up X-Forwarded-For {remote}
        header_up X-Real-IP {remote}
    }
}

# MagicPages API subdomain
api.magicpages.chrislawrence.ca:80 {
    reverse_proxy magicpages-api:8000 {
        header_up Host {host}
        header_up X-Forwarded-Host {host}
        header_up X-Forwarded-Proto https
        header_up X-Forwarded-For {remote}
        header_up X-Real-IP {remote}
    }
    
    # Static files
    handle_path /static/* {
        file_server {
            root /var/www/magicpages/static
        }
    }
    
    # Media files
    handle_path /media/* {
        file_server {
            root /var/www/magicpages/media
        }
    }
}

# EventSphere subdomain (mongo-events-demo)
eventsphere.chrislawrence.ca:80 {
    reverse_proxy mongo-events:5000
    header {
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization"
    }
    
    log {
        level INFO
        format json
        output file /data/logs/eventsphere.json {
            roll_size 15mb
            roll_keep 8
            roll_keep_for 168h
        }
    }
}

# BlueMap dedicated subdomain
map.minecraft.chrislawrence.ca:80 {
    reverse_proxy minecraft:8100 {
        header_down -X-Frame-Options
        header_down -Content-Security-Policy
    }
    log {
        level INFO
        format json
        output file /data/logs/minecraft-map.json {
            roll_size 15mb
            roll_keep 8
            roll_keep_for 168h
        }
    }
}

# ============================================================================
# PROTECTED SUBDOMAINS (Cloudflare Access Required)
# ============================================================================

# Development subdomain
dev.chrislawrence.ca:80 {
    # Dashboard/Organizr
    handle_path /dashboard {
        redir / 301
    }
    
    handle_path /dashboard/* {
        reverse_proxy organizr:80
    }
    
    # Infrastructure services
    handle_path /uptime {
        reverse_proxy uptime-kuma:3001 {
            header_down -X-Frame-Options
        }
    }
    
    handle_path /uptime/* {
        reverse_proxy uptime-kuma:3001 {
            header_down -X-Frame-Options
        }
    }

    handle_path /docker {
        reverse_proxy portainer:9000 {
            header_down -X-Frame-Options
        }
    }
    
    handle_path /docker/* {
        reverse_proxy portainer:9000 {
            header_down -X-Frame-Options
        }
    }

    handle_path /metrics {
        reverse_proxy grafana:3000 {
            header_down -X-Frame-Options
        }
    }
    
    handle_path /metrics/* {
        reverse_proxy grafana:3000 {
            header_down -X-Frame-Options
        }
    }

    handle_path /prometheus/* {
        reverse_proxy prometheus:9090
    }

    handle_path /containers/* {
        reverse_proxy cadvisor:8080
    }

    handle_path /system/* {
        reverse_proxy glances:61208
    }

    handle_path /tools/* {
        reverse_proxy it-tools:80
    }
    
    # Application services
    handle_path /n8n/* {
        reverse_proxy n8n-stack-n8n-1:5678 {
            header_up Connection {http.request.header.Connection}
            header_up Upgrade {http.request.header.Upgrade}
            header_down -X-Frame-Options
        }
    }

    handle_path /notes/* {
        reverse_proxy obsidian-notes:3000 {
            header_up Authorization "Basic b2JzaWRpYW46b2JzaWRpYW4xMjM="
            header_up Connection {http.request.header.Connection}
            header_up Upgrade {http.request.header.Upgrade}
            header_down -X-Frame-Options
        }
    }
    
    # Fallback for any unmatched paths -> send to Organizr
    handle {
        reverse_proxy organizr:80
    }
    
    log {
        level INFO
        format json
        output file /data/logs/dev-chrislawrence-ca.json {
            roll_size 50mb
            roll_keep 15
            roll_keep_for 720h
        }
    }
}

# Monitoring subdomain
monitor.chrislawrence.ca:80 {
    # Uptime Kuma
    handle_path /uptime {
        reverse_proxy uptime-kuma:3001 {
            header_down -X-Frame-Options
        }
    }
    
    handle_path /uptime/* {
        reverse_proxy uptime-kuma:3001 {
            header_down -X-Frame-Options
        }
    }

    # Grafana
    handle_path /grafana {
        reverse_proxy grafana:3000 {
            header_down -X-Frame-Options
        }
    }
    
    handle_path /grafana/* {
        reverse_proxy grafana:3000 {
            header_down -X-Frame-Options
        }
    }

    # Prometheus
    handle_path /prometheus/* {
        reverse_proxy prometheus:9090
    }

    # cAdvisor
    handle_path /containers/* {
        reverse_proxy cadvisor:8080
    }

    # Glances
    handle_path /system/* {
        reverse_proxy glances:61208
    }
    
    # Fallback
    handle {
        respond "Not Found" 404
    }
    
    log {
        level INFO
        format json
        output file /data/logs/monitor-chrislawrence-ca.json {
            roll_size 25mb
            roll_keep 10
            roll_keep_for 168h
        }
    }
}

# IoT subdomain
iot.chrislawrence.ca:80 {
    # Home Assistant
    handle_path /homeassistant/* {
        reverse_proxy homeassistant:8123 {
            header_down -X-Frame-Options
        }
    }

    # MQTT Explorer
    handle_path /mqtt/* {
        reverse_proxy mqtt-explorer:4000 {
            header_down -X-Frame-Options
        }
    }

    # Node-RED
    handle_path /nodered/* {
        reverse_proxy node-red:1880 {
            header_up Connection {http.request.header.Connection}
            header_up Upgrade {http.request.header.Upgrade}
            header_down -X-Frame-Options
        }
    }

    # Grafana IoT
    handle_path /grafana/* {
        reverse_proxy grafana-iot:3000 {
            header_down -X-Frame-Options
        }
    }

    # InfluxDB API
    handle_path /influxdb/* {
        reverse_proxy influxdb:8086
    }
    
    # Fallback
    handle {
        respond "Not Found" 404
    }
    
    log {
        level INFO
        format json
        output file /data/logs/iot-chrislawrence-ca.json {
            roll_size 25mb
            roll_keep 10
            roll_keep_for 168h
        }
    }
}

# Minecraft subdomain
minecraft.chrislawrence.ca:80 {
    # Minecraft map (BlueMap)
    handle_path /map/* {
        reverse_proxy minecraft:8100 {
            header_down -X-Frame-Options
            header_down -Content-Security-Policy
        }
    }
    
    # Fallback
    handle {
        respond "Not Found" 404
    }
    
    log {
        level INFO
        format json
        output file /data/logs/minecraft-chrislawrence-ca.json {
            roll_size 15mb
            roll_keep 8
            roll_keep_for 168h
        }
    }
}

# AI subdomain
ai.chrislawrence.ca:80 {
    # Open WebUI
    handle_path /webui/* {
        reverse_proxy ai-openwebui:8080 {
            header_down -X-Frame-Options
        }
    }
    
    # ComfyUI
    handle_path /comfyui/* {
        reverse_proxy ai-comfyui:8188 {
            header_down -X-Frame-Options
        }
    }
    
    # OpenRouter Proxy
    handle_path /openrouter/* {
        reverse_proxy ai-openrouter-proxy:8190
    }
    
    # Model Manager
    handle_path /models/* {
        reverse_proxy ai-model-manager:8191 {
            header_down -X-Frame-Options
        }
    }
    
    # Fallback
    handle {
        respond "Not Found" 404
    }
    
    log {
        level INFO
        format json
        output file /data/logs/ai-chrislawrence-ca.json {
            roll_size 25mb
            roll_keep 10
            roll_keep_for 168h
        }
    }
}

# ============================================================================
# PORT-BASED PROXIES (for Organizr embedding)
# ============================================================================

# Uptime Kuma proxy for Organizr embedding (port 8083)
:8083 {
    reverse_proxy uptime-kuma:3001 {
        header_down -X-Frame-Options
        header_down -Content-Security-Policy
    }
    header {
        -X-Frame-Options
        Content-Security-Policy "frame-ancestors *"
    }
}

# Portainer proxy for Organizr embedding (port 8084)
:8084 {
    reverse_proxy portainer:9000 {
        header_down -X-Frame-Options
        header_down -Content-Security-Policy
    }
    header {
        -X-Frame-Options
        Content-Security-Policy "frame-ancestors *"
    }
}

# Grafana proxy for Organizr embedding (port 8085)
:8085 {
    reverse_proxy grafana:3000 {
        header_down -X-Frame-Options
        header_down -Content-Security-Policy
    }
    header {
        -X-Frame-Options
        Content-Security-Policy "frame-ancestors *"
    }
}

# Prometheus proxy for Organizr embedding (port 8086)
:8086 {
    reverse_proxy prometheus:9090 {
        header_down -X-Frame-Options
        header_down -Content-Security-Policy
    }
    header {
        -X-Frame-Options
        Content-Security-Policy "frame-ancestors *"
    }
}

# cAdvisor proxy for Organizr embedding (port 8087)
:8087 {
    reverse_proxy cadvisor:8080 {
        header_down -X-Frame-Options
        header_down -Content-Security-Policy
    }
    header {
        -X-Frame-Options
        Content-Security-Policy "frame-ancestors *"
    }
}

# Glances proxy for Organizr embedding (port 8088)
:8088 {
    reverse_proxy glances:61208 {
        header_down -X-Frame-Options
        header_down -Content-Security-Policy
    }
    header {
        -X-Frame-Options
        Content-Security-Policy "frame-ancestors *"
    }
}

# IT-Tools proxy for Organizr embedding (port 8089)
:8089 {
    reverse_proxy it-tools:80 {
        header_down -X-Frame-Options
        header_down -Content-Security-Policy
    }
    header {
        -X-Frame-Options
        Content-Security-Policy "frame-ancestors *"
    }
}

# Obsidian Notes proxy for Organizr embedding (port 8090)
:8090 {
    reverse_proxy obsidian-notes:3000 {
        header_up Connection {http.request.header.Connection}
        header_up Upgrade {http.request.header.Upgrade}
        header_down -X-Frame-Options
        header_down -Content-Security-Policy
        header_up X-Forwarded-Proto http
        header_up X-Forwarded-Ssl off
    }
    header {
        -X-Frame-Options
        Content-Security-Policy "frame-ancestors *"
    }
}

# Magic Pages API proxy for Organizr embedding (port 8091)
:8091 {
    reverse_proxy magicpages-api:8000 {
        header_up Host localhost
        header_down -X-Frame-Options
        header_down -Content-Security-Policy
    }
    header {
        -X-Frame-Options
        Content-Security-Policy "frame-ancestors *"
    }
}

# n8n proxy for Organizr embedding (port 8092)
:8092 {
    reverse_proxy n8n-stack-n8n-1:5678 {
        header_up Connection {http.request.header.Connection}
        header_up Upgrade {http.request.header.Upgrade}
        header_down -X-Frame-Options
        header_down -Content-Security-Policy
    }
    header {
        -X-Frame-Options
        Content-Security-Policy "frame-ancestors *"
    }
}

# MQTT Explorer proxy for Organizr embedding (port 8093)
:8093 {
    reverse_proxy mqtt-explorer:4000 {
        header_down -X-Frame-Options
        header_down -Content-Security-Policy
    }
    header {
        -X-Frame-Options
        Content-Security-Policy "frame-ancestors *"
    }
}

# Home Assistant proxy for Organizr embedding (port 8094)
:8094 {
    basic_auth {
        admin $2a$14$w9sGeM752W5OBJfOXiRSWupEl2w75yu5WNIuNF9KMjBz42B4rrR7S
    }

    reverse_proxy homeassistant:8123 {
        header_down -X-Frame-Options
        header_down -Content-Security-Policy
    }
    header {
        -X-Frame-Options
        Content-Security-Policy "frame-ancestors *"
    }
}

# Node-RED proxy for Organizr embedding (port 8095)
:8095 {
    reverse_proxy node-red:1880 {
        header_up Connection {http.request.header.Connection}
        header_up Upgrade {http.request.header.Upgrade}
        header_down -X-Frame-Options
        header_down -Content-Security-Policy
    }
    header {
        -X-Frame-Options
        Content-Security-Policy "frame-ancestors *"
    }
}

# Grafana IoT proxy for Organizr embedding (port 8096)
:8096 {
    reverse_proxy grafana-iot:3000 {
        header_down -X-Frame-Options
        header_down -Content-Security-Policy
    }
    header {
        -X-Frame-Options
        Content-Security-Policy "frame-ancestors *"
    }
}

# daedalOS proxy for Organizr embedding (port 8158)
:8158 {
    reverse_proxy daedalos:3000 {
        header_down -X-Frame-Options
        header_down -Content-Security-Policy
    }
    header {
        -X-Frame-Options
        Content-Security-Policy "frame-ancestors *"
    }
}

# AI Services proxy ports (816X ports - for Organizr embedding)
:8161 {
    reverse_proxy ai-openwebui:8080 {
        header_down -X-Frame-Options
        header_down -Content-Security-Policy
    }
    header {
        -X-Frame-Options
        Content-Security-Policy "frame-ancestors *"
    }
}

:8162 {
    reverse_proxy ai-comfyui:8188 {
        header_down -X-Frame-Options
        header_down -Content-Security-Policy
    }
    header {
        -X-Frame-Options
        Content-Security-Policy "frame-ancestors *"
    }
}

:8163 {
    reverse_proxy ai-openrouter-proxy:8190 {
        header_down -X-Frame-Options
        header_down -Content-Security-Policy
    }
    header {
        -X-Frame-Options
        Content-Security-Policy "frame-ancestors *"
    }
}

:8164 {
    reverse_proxy ai-model-manager:8191 {
        header_down -X-Frame-Options
        header_down -Content-Security-Policy
    }
    header {
        -X-Frame-Options
        Content-Security-Policy "frame-ancestors *"
    }
}