# Hephaestus Homelab - Secure Caddy Configuration
# Subdomain-based routing with Cloudflare Access protection

# Global configuration
{
    admin 127.0.0.1:2019
    auto_https off
    http_port 80
}

localhost:80 {
    respond "Hello from Caddy!" 200
}

chrislawrence.ca:80 {
    root * /var/www/landing
    file_server
}

# www subdomain redirect to main domain
www.chrislawrence.ca:80 {
    redir https://chrislawrence.ca{uri} 301
}

# ============================================================================
# PUBLIC SUBDOMAINS (No Authentication Required) - TEMPORARILY COMMENTED OUT
# ============================================================================

# Portfolio subdomain
portfolio.chrislawrence.ca:80 {
    reverse_proxy portfolio:5000 {
        header_up X-Forwarded-Prefix /portfolio
        header_up Host {host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-For {remote}
        header_up X-Real-IP {remote}
    }
    
    log {
        level INFO
        format json
        output file /data/logs/portfolio.json {
            roll_size 15mb
            roll_keep 8
            roll_keep_for 168h
        }
    }
}

# SchedShare subdomain
schedshare.chrislawrence.ca:80 {
    reverse_proxy schedshare:5000 {
        header_up X-Forwarded-Prefix /schedshare
        header_up Host {host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-For {remote}
        header_up X-Real-IP {remote}
    }
    
    log {
        level INFO
        format json
        output file /data/logs/schedshare.json {
            roll_size 15mb
            roll_keep 8
            roll_keep_for 168h
        }
    }
}

# CapitolScope subdomain
capitolscope.chrislawrence.ca:80 {
    # API matcher
    @api path_regexp ^/api/.*
    
    # Handle API routes first (more specific)
    handle @api {
        reverse_proxy capitolscope:8000 {
            header_up Host {host}
            header_up X-Forwarded-Proto https
            header_up X-Forwarded-For {remote}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-Host {host}
        }
        header {
            Access-Control-Allow-Origin "*"
            Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
            Access-Control-Allow-Headers "Content-Type, Authorization"
        }
    }
    
    # Frontend - serve everything else to Vite dev server
    # Vite automatically serves files from the public/ directory
    handle {
        reverse_proxy capitolscope-frontend:5173 {
            header_up Host {host}
            header_up X-Forwarded-Proto https
            header_up X-Forwarded-For {remote}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-Host {host}
        }
    }
    
    log {
        level INFO
        format json
        output file /data/logs/capitolscope.json {
            roll_size 15mb
            roll_keep 8
            roll_keep_for 168h
        }
    }
}

# MagicPages Frontend subdomain
magicpages.chrislawrence.ca:80 {
    reverse_proxy magicpages-frontend:80 {
        header_up Host {host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-For {remote}
        header_up X-Real-IP {remote}
    }
    
    log {
        level INFO
        format json
        output file /data/logs/magicpages-frontend.json {
            roll_size 15mb
            roll_keep 8
            roll_keep_for 168h
        }
    }
}

# MagicPages API subdomain (one-level alternative)
magicpages-api.chrislawrence.ca:80 {
    reverse_proxy magicpages-api:8000 {
        header_up Host {host}
        header_up X-Forwarded-Host {host}
        header_up X-Forwarded-Proto https
        header_up X-Forwarded-For {remote}
        header_up X-Real-IP {remote}
    }
}

# EventSphere subdomain (mongo-events-demo)
eventsphere.chrislawrence.ca:80 {
    reverse_proxy mongo-events:5000
    header {
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization"
    }
    
    log {
        level INFO
        format json
        output file /data/logs/eventsphere.json {
            roll_size 15mb
            roll_keep 8
            roll_keep_for 168h
        }
    }
}

# BlueMap dedicated subdomain (one-level alternative)
minecraft-map.chrislawrence.ca:80 {
    reverse_proxy minecraft:8100 {
        header_down -X-Frame-Options
        header_down -Content-Security-Policy
    }
    log {
        level INFO
        format json
        output file /data/logs/minecraft-map.json {
            roll_size 15mb
            roll_keep 8
            roll_keep_for 168h
        }
    }
}

# ============================================================================
# PROTECTED SUBDOMAINS (Cloudflare Access Required)
# ============================================================================

# n8n subdomain
n8n.chrislawrence.ca:80 {
    reverse_proxy n8n-stack-n8n-1:5678 {
        header_up Host {host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-For {remote}
        header_up X-Real-IP {remote}
        header_up Connection {http.request.header.Connection}
        header_up Upgrade {http.request.header.Upgrade}
    }

    log {
        level INFO
        format json
        output file /data/logs/n8n.json {
            roll_size 15mb
            roll_keep 8
            roll_keep_for 168h
        }
    }
}

# uptime subdomain
uptime.chrislawrence.ca:80 {
    reverse_proxy uptime-kuma:3001 {
        header_down -X-Frame-Options
    }
    log {
        level INFO
        format json
        output file /data/logs/uptime-chrislawrence-ca.json {
            roll_size 15mb
            roll_keep 8
            roll_keep_for 168h
        }
    }
}

# Development subdomain
dev.chrislawrence.ca:80 {
    # Organizr (legacy dashboard, available at /organizr)
    handle_path /organizr {
        reverse_proxy organizr:80
    }
    
    handle_path /organizr/* {
        reverse_proxy organizr:80
    }

    handle_path /docker {
        reverse_proxy portainer:9000 {
            header_down -X-Frame-Options
        }
    }
    
    handle_path /docker/* {
        reverse_proxy portainer:9000 {
            header_down -X-Frame-Options
        }
    }

    handle_path /metrics {
        reverse_proxy grafana:3000 {
            header_down -X-Frame-Options
        }
    }
    
    handle_path /metrics/* {
        reverse_proxy grafana:3000 {
            header_down -X-Frame-Options
        }
    }

    handle_path /prometheus/* {
        reverse_proxy prometheus:9090
    }

    handle_path /containers/* {
        reverse_proxy cadvisor:8080
    }

    handle_path /system/* {
        reverse_proxy glances:61208
    }

    handle_path /tools/* {
        reverse_proxy it-tools:80
    }

    handle_path /notes/* {
        reverse_proxy obsidian-notes:3000 {
            header_up Authorization "Basic b2JzaWRpYW46b2JzaWRpYW4xMjM="
            header_up Connection {http.request.header.Connection}
            header_up Upgrade {http.request.header.Upgrade}
            header_down -X-Frame-Options
        }
    }
    
    # Fallback for any unmatched paths -> send to Dashy (main dashboard)
    handle {
        reverse_proxy dashy:80
    }
    
    log {
        level INFO
        format json
        output file /data/logs/dev-chrislawrence-ca.json {
            roll_size 50mb
            roll_keep 15
            roll_keep_for 720h
        }
    }
}

# Monitoring subdomain
monitor.chrislawrence.ca:80 {
    # Uptime Kuma
    handle_path /uptime {
        reverse_proxy uptime-kuma:3001 {
            header_down -X-Frame-Options
        }
    }
    
    handle_path /uptime/* {
        reverse_proxy uptime-kuma:3001 {
            header_down -X-Frame-Options
        }
    }

    # Grafana
    handle_path /grafana {
        reverse_proxy grafana:3000 {
            header_down -X-Frame-Options
        }
    }
    
    handle_path /grafana/* {
        reverse_proxy grafana:3000 {
            header_down -X-Frame-Options
        }
    }

    # Prometheus
    handle_path /prometheus/* {
        reverse_proxy prometheus:9090
    }

    # cAdvisor
    handle_path /containers/* {
        reverse_proxy cadvisor:8080
    }

    # Glances
    handle_path /system/* {
        reverse_proxy glances:61208
    }
    
    # Fallback
    handle {
        respond "Not Found" 404
    }
    
    log {
        level INFO
        format json
        output file /data/logs/monitor-chrislawrence-ca.json {
            roll_size 25mb
            roll_keep 10
            roll_keep_for 168h
        }
    }
}

# IoT subdomain
iot.chrislawrence.ca:80 {
    # Home Assistant
    handle_path /homeassistant/* {
        reverse_proxy homeassistant:8123 {
            header_down -X-Frame-Options
        }
    }

    # MQTT Explorer
    handle_path /mqtt/* {
        reverse_proxy mqtt-explorer:4000 {
            header_down -X-Frame-Options
        }
    }

    # Node-RED
    handle_path /nodered/* {
        reverse_proxy node-red:1880 {
            header_up Connection {http.request.header.Connection}
            header_up Upgrade {http.request.header.Upgrade}
            header_down -X-Frame-Options
        }
    }

    # Grafana IoT
    handle_path /grafana/* {
        reverse_proxy grafana-iot:3000 {
            header_down -X-Frame-Options
        }
    }

    # InfluxDB API
    handle_path /influxdb/* {
        reverse_proxy influxdb:8086
    }
    
    # Fallback
    handle {
        respond "Not Found" 404
    }
    
    log {
        level INFO
        format json
        output file /data/logs/iot-chrislawrence-ca.json {
            roll_size 25mb
            roll_keep 10
            roll_keep_for 168h
        }
    }
}

# Minecraft subdomain
minecraft.chrislawrence.ca:80 {
    # Minecraft map (BlueMap)
    handle_path /map/* {
        reverse_proxy minecraft:8100 {
            header_down -X-Frame-Options
            header_down -Content-Security-Policy
        }
    }
    
    # Fallback
    handle {
        respond "Not Found" 404
    }
    
    log {
        level INFO
        format json
        output file /data/logs/minecraft-chrislawrence-ca.json {
            roll_size 15mb
            roll_keep 8
            roll_keep_for 168h
        }
    }
}

# AI subdomain
ai.chrislawrence.ca:80 {
    # Open WebUI
    handle_path /webui/* {
        reverse_proxy ai-openwebui:8080 {
            header_down -X-Frame-Options
        }
    }
    
    # ComfyUI
    handle_path /comfyui/* {
        reverse_proxy ai-comfyui:8188 {
            header_down -X-Frame-Options
        }
    }
    
    # OpenRouter Proxy
    handle_path /openrouter/* {
        reverse_proxy ai-openrouter-proxy:8190
    }
    
    # Model Manager
    handle_path /models/* {
        reverse_proxy ai-model-manager:8191 {
            header_down -X-Frame-Options
        }
    }
    
    # Fallback
    handle {
        respond "Not Found" 404
    }
    
    log {
        level INFO
        format json
        output file /data/logs/ai-chrislawrence-ca.json {
            roll_size 25mb
            roll_keep 10
            roll_keep_for 168h
        }
    }
}

# ============================================================================
# PORT-BASED PROXIES - REMOVED
# ============================================================================
# Old Organizr embedding ports (8083-8164) have been removed.
# Access services directly via Tailscale using their port mappings,
# or through domain-based routing via Caddy.